<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.hotelmanagementsystem.mapper.ReviewMapper">

    <select id="findReviews" parameterType="org.example.hotelmanagementsystem.dto.ReviewQueryDto" resultType="org.example.hotelmanagementsystem.dto.ReviewDto">
        SELECT r.*, c.name AS customerName, h.name AS hotelName
        FROM reviews r
        LEFT JOIN customers c ON r.customer_id = c.id
        LEFT JOIN hotels h ON r.hotel_id = h.id
        WHERE 1=1
        <if test='id != null'>
            AND r.id = #{id}
        </if>
        <if test='orderId != null'>
            AND r.order_id = #{orderId}
        </if>
        <if test='customerId != null'>
            AND r.customer_id = #{customerId}
        </if>
        <if test='customerName != null and customerName != ""'>
            AND c.name LIKE CONCAT('%', #{customerName}, '%')
        </if>
        <if test='hotelId != null'>
            AND r.hotel_id = #{hotelId}
        </if>
        <if test='hotelName != null and hotelName != ""'>
            AND h.name LIKE CONCAT('%', #{hotelName}, '%')
        </if>
        <if test='rating != null'>
            AND r.rating = #{rating}
        </if>
        <if test='hasReply != null and hasReply == true'>
            AND r.reply IS NOT NULL AND r.reply != ''
        </if>
        <if test='hasReply != null and hasReply == false'>
            AND (r.reply IS NULL OR r.reply = '')
        </if>
        ORDER BY r.created_at DESC
    </select>

    <select id="getReviewById" parameterType="java.lang.Integer" resultType="org.example.hotelmanagementsystem.dto.ReviewDto">
        SELECT r.*, c.name AS customerName, h.name AS hotelName
        FROM reviews r
        LEFT JOIN customers c ON r.customer_id = c.id
        LEFT JOIN hotels h ON r.hotel_id = h.id
        WHERE r.id = #{id}
    </select>

    <select id="getReviewByOrderId" parameterType="java.lang.Integer" resultType="org.example.hotelmanagementsystem.entity.Review">
        SELECT * FROM reviews WHERE order_id = #{orderId}
    </select>

    <insert id="insertReview" parameterType="org.example.hotelmanagementsystem.entity.Review" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reviews(order_id, customer_id, hotel_id, rating, comment, created_at)
        VALUES(#{orderId}, #{customerId}, #{hotelId}, #{rating}, #{comment}, #{createdAt})
    </insert>

    <update id="updateReview" parameterType="org.example.hotelmanagementsystem.entity.Review">
        UPDATE reviews
        <set>
            <if test='rating != null'>rating = #{rating},</if>
            <if test='comment != null'>comment = #{comment},</if>
            created_at = #{createdAt}
        </set>
        WHERE id = #{id}
    </update>

    <update id="replyToReview">
        UPDATE reviews SET reply = #{reply} WHERE id = #{id}
    </update>

    <delete id="deleteReview" parameterType="java.lang.Integer">
        DELETE FROM reviews WHERE id = #{id}
    </delete>

</mapper>